{% extends 'base.html' %}
{% block title %} Resume Analyzer {% endblock %}
{% block content%} 
<h3>Resume Analyser</h3>

<form enctype="multipart/form-data" method="post" class="container mt-4">
  <div class="row g-3 align-items-stretch">
    <!-- LEFT: Dropzone box -->
    <div class="col-md-6 d-flex flex-column gap-3 border rounded">
      <div class="fw-semibold mb-2">Choose how to add your resume</div>

      <!-- Choice cards -->
      <div class="d-flex gap-3">
        <div id="card-existing" class="choice-card flex-fill border rounded p-3 text-center active" role="button">
          <i class="bi bi-folder2-open fs-3"></i>
          <div class="fw-semibold mt-2">Use Existing</div>
        </div>
        <div id="card-upload" class="choice-card flex-fill border rounded p-3 text-center" role="button">
          <i class="bi bi-upload fs-3"></i>
          <div class="fw-semibold mt-2">Upload New</div>
        </div>
      </div>

      <!-- Existing file dropdown -->
      <div id="existingContainer" class="mt-3">
        <label for="existingFile" class="form-label">Select a resume</label>
        <select name="existingFile" id="existingFile" class="form-select">
          <option value="">-- Choose a resume --</option>
          {% for resume in resumeList %}
            <option value="{{ resume.id }}">{{ resume.filename }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Upload container -->
      <div id="uploadContainer" class="mt-3 d-none">
        <label for="fileInput" class="form-label">Upload new resume</label>
        <div id="dropzone" class="dropzone border rounded d-flex flex-column align-items-center justify-content-center p-4 text-center">
          <input type="file" name="file" id="fileInput" class="d-none" accept=".pdf,.doc,.docx" />
          <i class="bi bi-cloud-arrow-up fs-1 mb-2"></i>
          <strong>Drop your resume here</strong>
          <div class="small text-muted">or click to browse (PDF/DOC)</div>
          <div id="selectedFile" class="small mt-2 text-truncate" style="max-width:240px;"></div>
        </div>
      </div>
    </div>

    <!-- RIGHT: Job info (title / company / description) -->
    <div class="col-md-6 d-flex">
      <div class="w-100 d-flex flex-column p-3 border rounded h-100">
        <div class="mb-3">
          <label for="job_title" class="form-label">Job Title</label>
          <input type="text" name="job_title" id="job_title" class="form-control" placeholder="e.g. Software Engineer">
        </div>

        <div class="mb-3">
          <label for="company" class="form-label">Company Name</label>
          <input type="text" name="company" id="company" class="form-control" placeholder="e.g. Google">
        </div>

        <div class="mb-3 flex-grow-1 d-flex flex-column">
          <label for="description" class="form-label">Job Description</label>
          <textarea name="description" id="description" class="form-control flex-grow-1" rows="6"
                    placeholder="Enter job description here..."></textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Submit button -->
  <div class="row mt-3">
    <div class="col text-center">
      <button type="submit" class="btn btn-primary">Analyse Resume</button>
    </div>
  </div>
</form>

<!-- Styles -->
<style>
  .dropzone {
    border: 2px dashed #ced4da;
    border-radius: 8px;
    background: rgba(0,0,0,0.01);
    transition: background .15s, border-color .15s;
    min-height: 100%; /* tries to fill column height */
    text-align: center;
  }

  .dropzone.dragover {
    background: rgba(0, 123, 255, 0.04);
    border-color: #0d6efd;
  }

  /* make sure the right-side container defines the height for stretch */
  .col-md-6 > .h-100 { height: 100%; }
</style>

<!-- JS: drag & drop + click-to-open file browser -->
<script>
  (function() {
    const dropzone = document.getElementById('dropzone');
    const fileInput = document.getElementById('fileInput');
    const selectedFile = document.getElementById('selectedFile');

    // Helper to show selected file name
    function showFileName(file) {
      if (!file) {
        selectedFile.textContent = '';
        return;
      }
      selectedFile.textContent = file.name + ' (' + Math.round(file.size/1024) + ' KB)';
    }

    // Click or keyboard activation triggers file chooser
    dropzone.addEventListener('click', () => fileInput.click());
    dropzone.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        fileInput.click();
      }
    });

    // When user chooses by browser dialog
    fileInput.addEventListener('change', (e) => {
      if (e.target.files && e.target.files[0]) {
        showFileName(e.target.files[0]);
      } else {
        showFileName(null);
      }
    });

    // Drag events
    ['dragenter', 'dragover'].forEach(ev => {
      dropzone.addEventListener(ev, (e) => {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.add('dragover');
      });
    });

    ['dragleave', 'dragend', 'mouseout'].forEach(ev => {
      dropzone.addEventListener(ev, (e) => {
        dropzone.classList.remove('dragover');
      });
    });

    // Drop handler
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      e.stopPropagation();
      dropzone.classList.remove('dragover');

      const dt = e.dataTransfer;
      if (!dt) return;

      const files = dt.files;
      if (!files || files.length === 0) return;

      // Only take first file (you can modify to accept multiple)
      const file = files[0];

      // Validate basic type (optional)
      // Allowed extensions: pdf, doc, docx
      const allowed = ['application/pdf',
                       'application/msword',
                       'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
      // Many browsers give generic MIME types; optionally check extension:
      const ext = file.name.split('.').pop().toLowerCase();
      const extAllowed = ['pdf','doc','docx'];

      if (!allowed.includes(file.type) && !extAllowed.includes(ext)) {
        alert('Unsupported file type. Please upload PDF or DOC/DOCX.');
        return;
      }

      // Put file into the hidden file input using a DataTransfer (works in modern browsers)
      const dataTransfer = new DataTransfer();
      dataTransfer.items.add(file);
      fileInput.files = dataTransfer.files;

      showFileName(file);
    });

    // Accessibility: prevent unexpected behaviour on focus out
    dropzone.addEventListener('blur', () => dropzone.classList.remove('dragover'));
  })();
</script>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const cardExisting = document.getElementById("card-existing");
    const cardUpload = document.getElementById("card-upload");
    const existingContainer = document.getElementById("existingContainer");
    const uploadContainer = document.getElementById("uploadContainer");

    function setActive(choice) {
      if (choice === "existing") {
        cardExisting.classList.add("active");
        cardUpload.classList.remove("active");
        existingContainer.classList.remove("d-none");
        uploadContainer.classList.add("d-none");
      } else {
        cardUpload.classList.add("active");
        cardExisting.classList.remove("active");
        uploadContainer.classList.remove("d-none");
        existingContainer.classList.add("d-none");
      }
    }

    cardExisting.addEventListener("click", () => setActive("existing"));
    cardUpload.addEventListener("click", () => setActive("upload"));
});
</script>

<style>
  .choice-card {
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .choice-card:hover {
    background-color: #f8f9fa;
  }
  .choice-card.active {
    border: 2px solid #0d6efd;
    background-color: #e7f1ff;
    box-shadow: 0 0 4px rgba(13,110,253,.3);
}
</style>

{% if score %}
<p>Score: {{score}}</p>
<style>
.progress-bar {
  width: var(--progress-width);
}
</style>

<div class="progress-bar" style="--progress-width: {{ score }}%;"
     role="progressbar" aria-valuenow="{{ score }}" aria-valuemin="0" aria-valuemax="100">
  {{ score }}%
</div>
{% endif %}
{% endblock %}